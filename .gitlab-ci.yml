# GitLab CI configuration using conda instead of pip
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  ROCKY_HOST: "10.0.0.213"
  ROCKY_USER: "rocky"
  PROJECT_DIR: "/home/rocky/orthoviewer"
  # Security: Use variables for sensitive connection info
  BASTION_HOST: "legolas.versailles.inrae.fr"
  BASTION_USER: "sgorboun"

stages:
  - test
  - build
  - deploy

# Backend tests using conda
test_backend:
  stage: test
  image: condaforge/mambaforge:latest
  before_script:
    - conda env create -f environment.yml
    - source activate orthoviewer2
  script:
    - cd backend
    - export PYTHONPATH="${PYTHONPATH}:$(pwd)"
    - conda run -n orthoviewer2 pytest tests/ --cov=app --cov-report=xml
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage.xml

# Validate bioinformatics platform readiness
validate_platform:
  stage: test
  image: condaforge/mambaforge:latest
  before_script:
    - conda env create -f environment.yml
    - source activate orthoviewer2
  script:
    - echo "Validating OrthoViewer2 Bioinformatics Platform"
    - cd backend
    - export PYTHONPATH="${PYTHONPATH}:$(pwd)"
    - echo "Testing genomics API endpoints..."
    - conda run -n orthoviewer2 python -c "from app.main import app; print('Platform ready')"
    - echo "Bioinformatics platform validation complete"
  only:
    - feat/GNP-6697-rocky-deployment

# Build Docker images
build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  script:
    - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA ./backend
    - docker build -t $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA ./frontend-vite
  only:
    - main
    - develop

# Pre-deployment safety confirmation - REQUIRED before deployment
pre_deploy_check:
  stage: deploy
  image: alpine:3.19
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    # Load SSH key for deployment
    - echo "$ROCKY_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # Configure SSH to match working local config
    - echo "Host legolas legolas.versailles.inrae.fr" >> ~/.ssh/config
    - echo "  HostName $BASTION_HOST" >> ~/.ssh/config
    - echo "  User $BASTION_USER" >> ~/.ssh/config
    - echo "  StrictHostKeyChecking no" >> ~/.ssh/config
    - echo "  ConnectTimeout 30" >> ~/.ssh/config
    - echo "  ServerAliveInterval 10" >> ~/.ssh/config
    - echo "  ServerAliveCountMax 3" >> ~/.ssh/config
    - echo "" >> ~/.ssh/config
    - echo "Host 10.0.0.*" >> ~/.ssh/config
    - echo "  ProxyJump $BASTION_HOST" >> ~/.ssh/config
    - echo "  User $ROCKY_USER" >> ~/.ssh/config
    - echo "  StrictHostKeyChecking no" >> ~/.ssh/config
    - echo "  ConnectTimeout 30" >> ~/.ssh/config
    - echo "  ServerAliveInterval 10" >> ~/.ssh/config
    - echo "  ServerAliveCountMax 3" >> ~/.ssh/config
    - chmod 600 ~/.ssh/config
  script:
    - echo "PRE-DEPLOYMENT SAFETY CHECK - ORTHOVIEWER DIRECTORY ONLY"
    - echo "Safety check by $GITLAB_USER_NAME"
    - echo "Testing bastion connectivity first..."
    - ssh -o ConnectTimeout=30 legolas.versailles.inrae.fr "echo 'Bastion connection successful'" || echo "WARNING - Bastion connection failed"
    - echo "Verifying orthoviewer directory structure"
    - ssh $ROCKY_HOST "ls -la $PROJECT_DIR" || echo "WARNING - Rocky connection failed"
    - echo "Checking current deployment status in orthoviewer directory"
    - ssh $ROCKY_HOST "cd $PROJECT_DIR && docker compose -f docker-compose.rocky.yml ps" || echo "WARNING - Cannot check deployment status"
    - echo "Testing current service availability"
    - ssh $ROCKY_HOST "curl -f http://localhost:8080" || echo "WARNING - Cannot test service"
    - echo "Checking available disk space for orthoviewer"
    - ssh $ROCKY_HOST "df -h /home/rocky" || echo "WARNING - Cannot check disk space"
    - echo "SAFETY CONFIRMATION - Ready for ISOLATED deployment to $PROJECT_DIR"
    - echo "Next step - Manually trigger deploy_rocky job"
    - echo "WARNING - This will ONLY affect $PROJECT_DIR directory"
    - echo "Note - If connectivity issues persist check network/firewall settings"
  only:
    - feat/GNP-6697-rocky-deployment
  when: manual
  allow_failure: true

# Deploy to Rocky VM - ISOLATED to orthoviewer directory only
deploy_rocky:
  stage: deploy
  image: alpine:3.19
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  before_script:
    - apk add --no-cache openssh-client tar
    - eval $(ssh-agent -s)
    # Load SSH key for deployment
    - echo "$ROCKY_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # Configure SSH to match working local config
    - echo "Host legolas legolas.versailles.inrae.fr" >> ~/.ssh/config
    - echo "  HostName $BASTION_HOST" >> ~/.ssh/config
    - echo "  User $BASTION_USER" >> ~/.ssh/config
    - echo "  StrictHostKeyChecking no" >> ~/.ssh/config
    - echo "  ConnectTimeout 30" >> ~/.ssh/config
    - echo "  ServerAliveInterval 10" >> ~/.ssh/config
    - echo "  ServerAliveCountMax 3" >> ~/.ssh/config
    - echo "" >> ~/.ssh/config
    - echo "Host 10.0.0.*" >> ~/.ssh/config
    - echo "  ProxyJump $BASTION_HOST" >> ~/.ssh/config
    - echo "  User $ROCKY_USER" >> ~/.ssh/config
    - echo "  StrictHostKeyChecking no" >> ~/.ssh/config
    - echo "  ConnectTimeout 30" >> ~/.ssh/config
    - echo "  ServerAliveInterval 10" >> ~/.ssh/config
    - echo "  ServerAliveCountMax 3" >> ~/.ssh/config
    - chmod 600 ~/.ssh/config
  script:
    - echo "üîí ISOLATED DEPLOYMENT TO ORTHOVIEWER DIRECTORY ONLY"
    - echo "Triggered by $GITLAB_USER_NAME"
    - echo "Target directory $PROJECT_DIR (isolated deployment)"
    - echo "Testing SSH connection with timeout..."
    - ssh -o ConnectTimeout=30 $ROCKY_HOST "whoami" || (echo "‚ùå SSH connection failed" && exit 1)
    - echo "Creating isolated backup in orthoviewer directory"
    - BACKUP_NAME="orthoviewer_backup_$(date +%Y%m%d_%H%M%S)"
    - ssh $ROCKY_HOST "if [ -d $PROJECT_DIR ]; then cp -r $PROJECT_DIR /home/rocky/$BACKUP_NAME && echo 'Backup created at /home/rocky/$BACKUP_NAME'; else echo 'No existing deployment to backup'; fi"
    - echo "Creating deployment package"
    - tar -czf deploy.tar.gz --exclude='.git' --exclude='node_modules' --exclude='__pycache__' .
    - echo "Uploading package to temporary location"
    - scp deploy.tar.gz $ROCKY_HOST:~/orthoviewer_deploy_temp.tar.gz
    - echo "Preparing isolated orthoviewer directory"
    - ssh $ROCKY_HOST "mkdir -p $PROJECT_DIR"
    - echo "Stopping existing containers (orthoviewer only)"
    - ssh $ROCKY_HOST "cd $PROJECT_DIR && docker compose -f docker-compose.rocky.yml down 2>/dev/null || echo 'No containers to stop'"
    - echo "Clearing orthoviewer directory for clean deployment"
    - ssh $ROCKY_HOST "rm -rf $PROJECT_DIR/* && echo 'Orthoviewer directory cleared'"
    - echo "Deploying to isolated orthoviewer directory"
    - ssh $ROCKY_HOST "cd $PROJECT_DIR && tar -xzf ~/orthoviewer_deploy_temp.tar.gz"
    - echo "Starting new deployment (orthoviewer containers only)"
    - ssh $ROCKY_HOST "cd $PROJECT_DIR && docker compose -f docker-compose.rocky.yml up -d"
    - echo "Cleaning up temporary files"
    - ssh $ROCKY_HOST "rm -f ~/orthoviewer_deploy_temp.tar.gz"
    - echo "Waiting for services to start"
    - sleep 10
    - echo "Testing deployment health"
    - ssh $ROCKY_HOST "curl -f http://localhost:8080 2>/dev/null && echo '‚úÖ Deployment successful' || echo '‚ùå Deployment failed'"
    - ssh $ROCKY_HOST "cd $PROJECT_DIR && docker compose -f docker-compose.rocky.yml ps"
    - echo "üéâ ISOLATED DEPLOYMENT COMPLETE by $GITLAB_USER_NAME"
    - echo "Only $PROJECT_DIR affected - system remains clean"
  only:
    - feat/GNP-6697-rocky-deployment
  when: manual
  allow_failure: true

# Health check job - Available to all team members (manual trigger)
health_check:
  stage: deploy
  image: alpine:3.19
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    # Load SSH key for deployment
    - echo "$ROCKY_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # Configure SSH to match working local config
    - echo "Host legolas legolas.versailles.inrae.fr" >> ~/.ssh/config
    - echo "  HostName $BASTION_HOST" >> ~/.ssh/config
    - echo "  User $BASTION_USER" >> ~/.ssh/config
    - echo "  StrictHostKeyChecking no" >> ~/.ssh/config
    - echo "  ConnectTimeout 30" >> ~/.ssh/config
    - echo "  ServerAliveInterval 10" >> ~/.ssh/config
    - echo "  ServerAliveCountMax 3" >> ~/.ssh/config
    - echo "" >> ~/.ssh/config
    - echo "Host 10.0.0.*" >> ~/.ssh/config
    - echo "  ProxyJump $BASTION_HOST" >> ~/.ssh/config
    - echo "  User $ROCKY_USER" >> ~/.ssh/config
    - echo "  StrictHostKeyChecking no" >> ~/.ssh/config
    - echo "  ConnectTimeout 30" >> ~/.ssh/config
    - echo "  ServerAliveInterval 10" >> ~/.ssh/config
    - echo "  ServerAliveCountMax 3" >> ~/.ssh/config
    - chmod 600 ~/.ssh/config
  script:
    - echo "üîç Checking orthoviewer deployment health (isolated check)"
    - echo "Health check triggered by $GITLAB_USER_NAME"
    - echo "Checking containers in orthoviewer directory only"
    - ssh $ROCKY_HOST "cd $PROJECT_DIR && docker-compose -f docker-compose.rocky.yml ps" || echo "‚ö†Ô∏è Cannot check containers"
    - ssh $ROCKY_HOST "curl -f http://localhost:8080" || echo "‚ö†Ô∏è Service not responding"
    - echo "‚úÖ Orthoviewer health check complete"
  only:
    - feat/GNP-6697-rocky-deployment
  when: manual
  allow_failure: true
