# GitLab CI configuration using conda instead of pip
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  ROCKY_HOST: "10.0.0.213"
  ROCKY_USER: "rocky"
  PROJECT_DIR: "/home/rocky/orthoviewer"
  # Security: Use variables for sensitive connection info
  BASTION_HOST: "138.102.145.13"
  BASTION_USER: "sgorboun"

stages:
  - test
  - build
  - deploy

# Backend tests using conda
test_backend:
  stage: test
  image: condaforge/mambaforge:latest
  before_script:
    - conda env create -f environment.yml
    - source activate orthoviewer2
  script:
    - cd backend
    - export PYTHONPATH="${PYTHONPATH}:$(pwd)"
    - conda run -n orthoviewer2 pytest tests/ --cov=app --cov-report=xml
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage.xml

# Validate bioinformatics platform readiness
validate_platform:
  stage: test
  image: condaforge/mambaforge:latest
  before_script:
    - conda env create -f environment.yml
    - source activate orthoviewer2
  script:
    - echo "üß¨ Validating OrthoViewer2 Bioinformatics Platform"
    - cd backend
    - export PYTHONPATH="${PYTHONPATH}:$(pwd)"
    - echo "‚úÖ Testing genomics API endpoints..."
    - conda run -n orthoviewer2 python -c "
      from app.main import app;
      from app.api.biological_routes import load_mock_data;
      print('‚úÖ FastAPI app loaded successfully');
      data = load_mock_data('genes.json');
      print(f'‚úÖ Mock data loaded: {len(data.get(\"genes\", []))} genes');
      print('üß¨ Platform ready for genomics workflows!')
      "
    - echo "üöÄ Bioinformatics platform validation complete!"
  only:
    - feat/GNP-6697-rocky-deployment

# Build Docker images
build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA ./backend
    - docker build -t $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA ./frontend-vite
  only:
    - main
    - develop

# Pre-deployment safety confirmation - REQUIRED before deployment
pre_deploy_check:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # Configure SSH for ProxyJump through INRAE bastion
    - echo "Host legolas" >> ~/.ssh/config
    - echo "  HostName $BASTION_HOST" >> ~/.ssh/config
    - echo "  User $BASTION_USER" >> ~/.ssh/config
    - echo "  StrictHostKeyChecking no" >> ~/.ssh/config
    - echo "" >> ~/.ssh/config
    - echo "Host rocky" >> ~/.ssh/config
    - echo "  HostName $ROCKY_HOST" >> ~/.ssh/config
    - echo "  User $ROCKY_USER" >> ~/.ssh/config
    - echo "  ProxyJump legolas" >> ~/.ssh/config
    - echo "  StrictHostKeyChecking no" >> ~/.ssh/config
    - chmod 600 ~/.ssh/config
  script:
    - echo "üîí PRE-DEPLOYMENT SAFETY CHECK"
    - echo "üë§ Safety check by $GITLAB_USER_NAME ($GITLAB_USER_LOGIN)"
    - echo "üîç Verifying current deployment status..."
    - ssh rocky "cd $PROJECT_DIR && docker compose -f docker-compose.rocky.yml ps" || echo "‚ÑπÔ∏è No current deployment found"
    - echo "üåê Testing current service availability..."
    - ssh rocky "curl -f http://localhost:8080 2>/dev/null && echo '‚úÖ Current service is healthy' || echo '‚ö†Ô∏è Current service not responding'"
    - echo "üíæ Checking available disk space..."
    - ssh rocky "df -h $PROJECT_DIR"
    - echo "üõ°Ô∏è SAFETY CONFIRMATION: Ready for deployment"
    - echo "‚ÑπÔ∏è Next step: Manually trigger 'deploy_rocky' job if you want to proceed"
    - echo "‚ö†Ô∏è WARNING: This will create a backup and replace the current deployment"
  only:
    - feat/GNP-6697-rocky-deployment
  when: manual

# Deploy to Rocky VM - Available to all team members with repo access
deploy_rocky:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client tar
    - eval $(ssh-agent -s)
    # Temporarily commenting out SSH key loading - keys already established
    # - echo "$ROCKY_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # Configure SSH for ProxyJump through INRAE bastion
    - echo "Host legolas" >> ~/.ssh/config
    - echo "  HostName $BASTION_HOST" >> ~/.ssh/config
    - echo "  User $BASTION_USER" >> ~/.ssh/config
    - echo "  StrictHostKeyChecking no" >> ~/.ssh/config
    - echo "" >> ~/.ssh/config
    - echo "Host rocky" >> ~/.ssh/config
    - echo "  HostName $ROCKY_HOST" >> ~/.ssh/config
    - echo "  User $ROCKY_USER" >> ~/.ssh/config
    - echo "  ProxyJump legolas" >> ~/.ssh/config
    - echo "  StrictHostKeyChecking no" >> ~/.ssh/config
    - chmod 600 ~/.ssh/config
  script:
    - echo "üõ°Ô∏è DEPLOYMENT SAFETY CHECK - Protecting existing deployment"
    - echo "üë§ Triggered by $GITLAB_USER_NAME ($GITLAB_USER_LOGIN)"
    - echo "üîç Checking current deployment status..."
    - ssh rocky "cd $PROJECT_DIR && docker compose -f docker-compose.rocky.yml ps" || echo "No current deployment found"
    - echo "Testing SSH connection through bastion"
    - ssh -o ConnectTimeout=10 rocky "whoami"
    - echo "üì¶ Creating PROTECTED backup of existing deployment"
    - BACKUP_NAME="${PROJECT_DIR}_backup_$(date +%Y%m%d_%H%M%S)_by_${GITLAB_USER_LOGIN}"
    - ssh rocky "if [ -d $PROJECT_DIR ]; then cp -r $PROJECT_DIR $BACKUP_NAME && echo '‚úÖ Protected backup created at $BACKUP_NAME'; else echo '‚ÑπÔ∏è No existing deployment to backup'; fi"
    - echo "üìã Creating deployment package"
    - tar -czf deploy.tar.gz --exclude='.git' --exclude='node_modules' --exclude='__pycache__' .
    - echo "üì§ Uploading package"
    - scp deploy.tar.gz rocky:~/
    - echo "üîÑ Deploying on remote (this will restart services)"
    - ssh rocky "mkdir -p $PROJECT_DIR && cd $PROJECT_DIR && tar -xzf ~/deploy.tar.gz"
    - echo "‚èπÔ∏è Stopping existing containers gracefully"
    - ssh rocky "cd $PROJECT_DIR && docker compose -f docker-compose.rocky.yml down || echo 'No containers to stop'"
    - echo "üöÄ Starting new deployment"
    - ssh rocky "cd $PROJECT_DIR && docker compose -f docker-compose.rocky.yml up -d"
    - echo "‚è±Ô∏è Waiting for services to start..."
    - sleep 10
    - echo "üè• Testing new deployment health..."
    - if ssh rocky "curl -f http://localhost:8080/health 2>/dev/null || curl -f http://localhost:8080 2>/dev/null"; then
        echo "‚úÖ Deployment successful and healthy!";
        ssh rocky "cd $PROJECT_DIR && docker compose -f docker-compose.rocky.yml ps";
        echo "üéâ Deployment complete by $GITLAB_USER_NAME!";
      else
        echo "‚ùå New deployment failed health check - INITIATING ROLLBACK";
        echo "üîÑ Rolling back to previous deployment...";
        ssh rocky "cd $PROJECT_DIR && docker compose -f docker-compose.rocky.yml down";
        ssh rocky "if [ -d $BACKUP_NAME ]; then rm -rf $PROJECT_DIR && mv $BACKUP_NAME $PROJECT_DIR && echo '‚Ü©Ô∏è Rollback completed'; fi";
        ssh rocky "cd $PROJECT_DIR && docker compose -f docker-compose.rocky.yml up -d";
        echo "üõ°Ô∏è Rollback complete - original deployment restored";
        exit 1;
      fi
    - echo "üìä Final status check:"
    - ssh rocky "cd $PROJECT_DIR && docker compose -f docker-compose.rocky.yml ps"
  only:
    - feat/GNP-6697-rocky-deployment
  when: manual
  allow_failure: true

# Health check job - Available to all team members (manual trigger)
health_check:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    # Temporarily commenting out SSH key loading - keys already established  
    # - echo "$ROCKY_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # Configure SSH for ProxyJump through INRAE bastion
    - echo "Host legolas" >> ~/.ssh/config
    - echo "  HostName $BASTION_HOST" >> ~/.ssh/config
    - echo "  User $BASTION_USER" >> ~/.ssh/config
    - echo "  StrictHostKeyChecking no" >> ~/.ssh/config
    - echo "" >> ~/.ssh/config
    - echo "Host rocky" >> ~/.ssh/config
    - echo "  HostName $ROCKY_HOST" >> ~/.ssh/config
    - echo "  User $ROCKY_USER" >> ~/.ssh/config
    - echo "  ProxyJump legolas" >> ~/.ssh/config
    - echo "  StrictHostKeyChecking no" >> ~/.ssh/config
    - chmod 600 ~/.ssh/config
  script:
    - echo "üîç Checking Rocky deployment health via ProxyJump"
    - echo "üë§ Health check triggered by $GITLAB_USER_NAME ($GITLAB_USER_LOGIN)"
    - ssh rocky "cd $PROJECT_DIR && docker-compose -f docker-compose.rocky.yml ps"
    - ssh rocky "curl -f http://localhost:8080"
    - echo "‚úÖ Health check complete by $GITLAB_USER_NAME!"
  only:
    - feat/GNP-6697-rocky-deployment
  when: manual
